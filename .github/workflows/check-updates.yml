name: Check and Update ns3

on:
  schedule:
    # Run every 7 days at 00:00 UTC (tweak as you like)
    - cron: '0 0 */7 * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version unchanged'
        required: false
        default: false
        type: boolean
      increment_pkgrel:
        description: 'Increment pkgrel (for same version updates)'
        required: false
        default: false
        type: boolean

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check for latest ns3 version
      id: check
      run: |
        set -euo pipefail

        # Find latest ns-allinone-X.Y from the installation guide
        HTML=$(curl -fsSL "https://www.nsnam.org/docs/installation/singlehtml/index.html")

        LATEST_VERSION=$(echo "$HTML" \
          | grep -oP 'ns-allinone-\K[0-9]+\.[0-9]+' \
          | sort -Vu \
          | tail -n1 || true)

        if [[ -z "$LATEST_VERSION" ]]; then
          echo "Error: could not determine latest ns3 version" >&2
          exit 1
        fi

        echo "Latest upstream ns-allinone version: $LATEST_VERSION"
        echo "latest_version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"

        # Get current version from AUR ns3 PKGBUILD
        CURRENT_VERSION=$(curl -fsSL "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=ns3-simple" \
          | awk -F= '/^pkgver=/{print $2; exit}' || echo "none")

        echo "Current version in AUR: $CURRENT_VERSION"
        echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

        if [[ "$LATEST_VERSION" != "$CURRENT_VERSION" ]] || [[ "${{ inputs.force_update }}" == "true" ]]; then
          echo "update_needed=true" >> "$GITHUB_OUTPUT"
        else
          echo "update_needed=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Download ns-allinone tarball and calculate checksum
      if: steps.check.outputs.update_needed == 'true'
      id: download
      run: |
        set -euo pipefail

        VERSION="${{ steps.check.outputs.latest_version }}"
        URL="https://www.nsnam.org/releases/ns-allinone-${VERSION}.tar.bz2"

        echo "Downloading: $URL"
        curl -fSL "$URL" -o ns-allinone.tar.bz2

        CHECKSUM=$(sha256sum ns-allinone.tar.bz2 | cut -d ' ' -f1)
        echo "sha256sum=$CHECKSUM" >> "$GITHUB_OUTPUT"

        rm ns-allinone.tar.bz2

    - name: Get current pkgrel from AUR
      if: steps.check.outputs.update_needed == 'true'
      id: current_pkgrel
      run: |
        set -euo pipefail

        PKGBUILD=$(curl -s "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=ns3" || true)

        CURRENT_PKGREL=$(echo "$PKGBUILD" | awk -F= '/^pkgrel=/{print $2; exit}' || echo "1")
        echo "current_pkgrel=$CURRENT_PKGREL" >> "$GITHUB_OUTPUT"

        AUR_VERSION=$(echo "$PKGBUILD" | awk -F= '/^pkgver=/{print $2; exit}' || echo "none")
        if [[ "$AUR_VERSION" == "${{ steps.check.outputs.latest_version }}" ]]; then
          echo "same_version=true" >> "$GITHUB_OUTPUT"
        else
          echo "same_version=false" >> "$GITHUB_OUTPUT"
        fi
      continue-on-error: true

    - name: Determine pkgrel
      if: steps.check.outputs.update_needed == 'true'
      id: pkgrel
      run: |
        set -euo pipefail

        if [[ "${{ steps.current_pkgrel.outputs.same_version }}" == "true" ]] \
           && [[ "${{ inputs.increment_pkgrel }}" == "true" ]]; then
          CURRENT=${{ steps.current_pkgrel.outputs.current_pkgrel }}
          NEW_PKGREL=$((CURRENT + 1))
          echo "pkgrel=$NEW_PKGREL" >> "$GITHUB_OUTPUT"
        else
          echo "pkgrel=1" >> "$GITHUB_OUTPUT"
        fi

    - name: Create PKGBUILD
      if: steps.check.outputs.update_needed == 'true'
      run: |
        set -euo pipefail

        mkdir -p aur-package

        cat > aur-package/PKGBUILD << 'EOF_PKG'
        # Maintainer: MLM-stuff gfxoxinzh@mozmail.com
        
        pkgname=ns3-simple
        pkgver=${{ steps.check.outputs.latest_version }}
        pkgrel=${{ steps.pkgrel.outputs.pkgrel }}
        pkgdesc='Discrete-event network simulator for Internet systems'
        arch=('x86_64')
        url='https://www.nsnam.org/'
        license=('GPL-2.0-only')
        options=('!lto')
        
        depends=(
          'python'              # ns3 wrapper & bindings
          'python-cppyy'        # cppyy / CPyCppyy / backend from extra
          'dpdk'
          'sqlite'
          'qt5-base'            # netanim
          'openmpi'
          'eigen'
          'gsl'
          'libxml2'
          'gtk3'
          'boost-libs'
          'glibc'
          'libpcap'
          # VM / tap bridge
          'lxc' 'vtun' 'ebtables' 'bridge-utils'
          # pyviz
          'goocanvas' 'python-gobject' 'python-cairo' 'python-pygraphviz'
          'ipython'
        )
        
        makedepends=(
          'cmake'
          'boost'
          'git'
          'mercurial'
          # docs
          'doxygen' 'graphviz' 'imagemagick' 'python-sphinx' 'texlive-bin'
        )
        
        optdepends=(
          'uncrustify: utils/check-style.py style checks'
          'dia: documentation diagrams'
        )
        
        provides=('ns3')
        conflicts=('ns3' 'ns3-git' 'ns3-hg')
        
        source=(
          "https://www.nsnam.org/releases/ns-allinone-${pkgver}.tar.bz2"
        )
        
        sha256sums=(
          '${{ steps.download.outputs.sha256sum }}'
        )
        
        prepare() {
          cd "${srcdir}/ns-allinone-${pkgver}/ns-${pkgver}"
        
          # DPDK API compatibility (harmless if upstream already fixed)
          if [[ -f src/fd-net-device/model/dpdk-net-device.cc ]]; then
            sed -i "src/fd-net-device/model/dpdk-net-device.cc" \
              -e 's/CALL_MASTER/CALL_MAIN/' \
              -e 's/ETH_LINK_DOWN/RTE_ETH_LINK_DOWN/' \
              -e 's/ETH_MQ_TX_NONE/RTE_ETH_MQ_TX_NONE/' \
              -e 's/DEV_TX_OFFLOAD_MBUF_FAST_FREE/RTE_ETH_TX_OFFLOAD_MBUF_FAST_FREE/' \
              -e '/split_hdr_size/d' || true
          fi
        }
        
        build() {
          cd "${srcdir}/ns-allinone-${pkgver}/ns-${pkgver}"
        
          local pyver
          pyver="$(
            python - << 'EOF'
        import sys
        print(f"{sys.version_info[0]}.{sys.version_info[1]}")
        EOF
          )"
          local py_site="lib/python${pyver}/site-packages"
        
          ./ns3 configure \
            --build-profile=default \
            --enable-dpdk \
            --enable-eigen \
            --enable-examples \
            --enable-gsl \
            --enable-gtk \
            --enable-logs \
            --enable-monolib \
            --enable-mpi \
            --enable-python-bindings \
            --enable-tests \
            --prefix=/usr \
            -- \
            -DNS3_BINDINGS_INSTALL_DIR="/usr/${py_site}"
        
          ./ns3 build
        
          # Clean absolute $srcdir from pkg-config files in build tree
          find -L . -name '*.pc' -exec \
            sed -e "s,[^[:blank:]]\+${srcdir}[^[:blank:]]\+,,g" -i {} +
        }
        
        check() {
          cd "${srcdir}/ns-allinone-${pkgver}/ns-${pkgver}"
          ./ns3 run "hello-simulator" || echo "ns3 hello-simulator failed (ignored)"
        }
        
        package() {
          # netanim (if present in allinone)
          if compgen -G "${srcdir}/ns-allinone-${pkgver}/netanim-*" > /dev/null; then
            cd "${srcdir}/ns-allinone-${pkgver}/netanim"-*
            install -Dm755 NetAnim "${pkgdir}/usr/bin/netanim"
          fi
        
          # ns-3 core
          cd "${srcdir}/ns-allinone-${pkgver}/ns-${pkgver}"
          DESTDIR="${pkgdir}" ./ns3 install
        
          # Install Python 'ns' package into site-packages
          local pyver py_site
          pyver="$(
            python - << 'EOF'
        import sys
        print(f"{sys.version_info[0]}.{sys.version_info[1]}")
        EOF
          )"
          py_site="${pkgdir}/usr/lib/python${pyver}/site-packages"
          install -d "${py_site}/ns"
          install -m644 bindings/python/ns__init__.py "${py_site}/ns/__init__.py"
        
          # Strip any hardcoded $srcdir references from installed files
          mapfile -t files < <(grep -R --binary-files=without-match -l "${srcdir}" "${pkgdir}" || true)
          if ((${#files[@]})); then
            sed -i "s,${srcdir},,g" "${files[@]}"
          fi
        }
        
        # vim: set ts=2 sw=2 et:
        EOF_PKG

    - name: Publish to AUR
      if: steps.check.outputs.update_needed == 'true'
      uses: mlm-games/aur-deploy-action@master
      with:
        pkgname: ns3-simple
        pkgbuild: aur-package/PKGBUILD
        commit_username: MLM-stuff
        commit_email: gfxoxinzh@mozmail.com
        ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        commit_message: "ns3-simple: update to ${{ steps.check.outputs.latest_version }}-${{ steps.pkgrel.outputs.pkgrel }}"
